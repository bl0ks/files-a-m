(function(m){var r=window.AmazonUIPageJS||window.P,A=r._namespace||r.attributeErrors,g=A?A("RexMaptrackingJS",""):r;g.guardFatal?g.guardFatal(m)(g,window):g.execute(function(){m(g,window)})})(function(m,r,A){m.declare("rex-maptracker-constants",{classPrefix:"rex-maptracking",maxZoom:17,minZoom:3,platform:{here:{apikey:"ltobbDHZkLMrOImgoKOORj4TNWbLhM28jtZ1fcL4YaM",useHTTPS:!0}},styles:{deliveryAgentBubble:{style:{body:{backgroundColor:"#fff",color:"#000",fontSize:".8em",padding:".3em .1em",right:"-3.75em",
    bottom:"4em",borderRadius:"1em",textAlign:"center"},content:{minWidth:"8em"}},tail:{path:{fill:"#FFF"},viewBox:"0 0 20 20",shape:"M0 0 L6 8 L12 0 Z",style:{bottom:"2em"}}},destinationBubble:{style:{body:{backgroundColor:"#fff",color:"#000",fontSize:".8em",padding:".3em .1em",right:"-3.75em",bottom:"2.5em",borderRadius:"1em",textAlign:"center"},content:{minWidth:"8em"}}}},metrics:{PIN_SMOOTHING_MAP_UPDATE_ERROR:"pin-smoothing-map-update-error",PIN_SMOOTHING_MAP_UPDATE_ERROR_LOG:"pin-smoothing-map-update-error-log",
    PIN_SMOOTHING_AJAX_ERROR:"pin-smoothing-ajax-error",PIN_SMOOTHING_KALMAN_FILTER_UPDATE:"pin-smoothing-kalman-filter-update",PIN_SMOOTHING_KALMAN_FILTER_UPDATE_ERROR:"pin-smoothing-kalman-filter-update-error",PIN_SMOOTHING_KALMAN_FILTER_UPDATE_ERROR_LOG:"pin-smoothing-kalman-filter-update-error-log",PIN_SMOOTHING_ROUTE_FILTER_HIT:"pin-smoothing-route-filter-hit",PIN_SMOOTHING_ROUTE_FILTER_SUCCESS:"pin-smoothing-route-filter-success",PIN_SMOOTHING_ROUTE_FILTER_EMPTY_RESPONSE:"pin-smoothing-route-filter-empty-response",
    PIN_SMOOTHING_ROUTE_FILTER_EMPTY_ROUTE:"pin-smoothing-route-filter-empty-route",PIN_SMOOTHING_ROUTE_FILTER_ERROR:"pin-smoothing-route-filter-error",PIN_SMOOTHING_ROUTE_FILTER_ERROR_LOG:"pin-smoothing-route-filter-error-log",HERE_ROUTE_MATCHING_LATENCY:"here-route-matching-latency"}});m.register("rex-maptracker-environments",function(){function g(){var d=r.location.hostname,f="";null!=d&&""!=d&&(f=d.split(".").pop());return f}function e(){var d=!1,f=r.location.hostname;l.forEach(function(a){f.includes(a)&&
    (d=!0)});return d}var l=["development","pre-prod"],h={com:{region:"na",domain:"com",imperial:!0},uk:{region:"eu",domain:"co.uk",imperial:!1},de:{region:"eu",domain:"de",imperial:!1},fr:{region:"eu",domain:"fr",imperial:!1},es:{region:"eu",domain:"es",imperial:!1},it:{region:"eu",domain:"it",imperial:!1},"":{region:"na",domain:"com",imperial:!0}};return{getTopLevelDomain:g,getEnvConfig:function(){var d=e(),f;d?(f=r.location.hostname.split(".")[0],f=f.substring(0,f.indexOf("pre-prod")-1)):f=g();h[f]||
    (f="com");f=h[f]||{};f.isPreProd=d;return f}}});m.when("A","rex-maptracker-constants","rex-maptracker-icons","pin-smoothing-config","prime-day-cheer").register("rex-maptracker-item",function(g,e,l,h,d){function f(a,k,b,d){this.type=a;this.latitude=k;this.longitude=b;this.bubbleContent=d||"";this.iconSrc=l[a]||l.default;this.initialized=!1;this.markerDomRef=null;this.resetTransitionEventListener=this.resetTransition.bind(this)}f.itemType={DELIVERY_AGENT:"agent",DESTINATION:"destination"};f.prototype.init=
    function(a){this.initialized||(this.maptracker=a,a={},this.type===f.itemType.DELIVERY_AGENT&&(a.onAttach=this.onAttach.bind(this),a.onDetach=this.onDetach.bind(this)),this.icon=d.isEnabled&&this.type===f.itemType.DELIVERY_AGENT?d.instantiateAnimatedDeliveryAgentIcon(a):this.instantiateIcon(a),this.marker=this.instantiateMarker(),this.bubble=this.type===f.itemType.DELIVERY_AGENT?e.styles.deliveryAgentBubble:e.styles.destinationBubble,this.updateBubble(this.bubbleContent),this.maptracker.map.addObject(this.marker),
    this.initialized=!0)};f.prototype.instantiateIcon=function(a){var k=document.createElement("img");k.crossOrigin="anonymous";k.src=this.iconSrc;k.classList.add("pt-map-item-icon");k.classList.add("pt-map-item-icon__"+this.type);var b=document.createElement("div");b.classList.add("pt-map-item-icon-container");b.classList.add("pt-map-item-icon-container__"+this.type);b.appendChild(k);try{return new H.map.DomIcon(b,a)}catch(d){}};f.prototype.instantiateMarker=function(){try{return new H.map.DomMarker({lat:this.latitude,
    lng:this.longitude},{icon:this.icon})}catch(a){}};f.prototype.updateBubble=function(a){this.bubble.instant||(this.type===f.itemType.DELIVERY_AGENT?this.instantiateAgent():this.instantiateDestination());this.bubbleContent=a;this.bubble.instant&&(this.bubble.instant.setContent(this.bubbleContent),this.bubbleContent?this.bubble.instant.open():this.bubble.instant.close(),this.marker&&this.bubble.instant.setPosition(this.marker.getGeometry()))};f.prototype.updateLocation=function(a,k,b){this.latitude=
    a;this.longitude=k;b||this.resetTransition();this.marker&&(this.marker.setGeometry({lat:a,lng:k}),this.bubble.instant.setPosition({lat:a,lng:k}))};f.prototype.remove=function(){this.maptracker.map.removeObject(this.marker);this.maptracker.ui.removeBubble(this.bubble)};f.prototype.instantiateAgent=function(){this.bubble.instant=new H.ui.InfoBubble(this.marker.getGeometry(),{content:""});var a=this.maptracker.mapElement.id+"-da-bubble";this.bubble.instant.addClass(a);this.maptracker.ui.addBubble(this.bubble.instant);
    var a=g.$("."+a),k=a.children(".H_ib_body"),b=document.querySelector(".H_ib_body");b.classList.remove("H_ib_body");b.classList.add("agent");k.children(".H_ib_close").hide();k=document.querySelector(".H_ib_content");k.classList.remove("H_ib_content");k.classList.add("bubble-content");a=a.children(".H_ib_tail");k=g.$("\x3cg\x3e").append(g.$("\x3cpath\x3e").attr("d",this.bubble.tail.shape).css(this.bubble.tail.path));k=g.$("\x3csvg\x3e").attr("viewBox",this.bubble.tail.viewBox).append(k);a.html(k);k=
    document.querySelector(".H_ib_tail");k.classList.add("agent-tail");k.classList.remove("H_ib_tail");a.html(a.html())};f.prototype.instantiateDestination=function(){this.bubble.instant=new H.ui.InfoBubble(this.marker.getGeometry(),{content:""});var a=this.maptracker.mapElement.id+"-de-bubble";this.bubble.instant.addClass(a);this.maptracker.ui.addBubble(this.bubble.instant);a=g.$("."+a);a.css({height:"0"});var k=document.querySelector(".H_ib_body");k.classList.remove("H_ib_body");k.classList.add("destination");
    var b=document.querySelector(".H_ib_content");b.classList.remove("H_ib_content");b.classList.add("bubble-content");a.children(".destination").children(".H_ib_close").hide();b=document.querySelector(".H_ib_tail");b.classList.remove("H_ib_tail");b.classList.add("destination-tail");a.children(".destination-tail").hide();k.classList.add("show-destination")};f.prototype.onAttach=function(a){this.markerDomRef=a;this.resetTransition();this.maptracker&&this.maptracker.map&&this.maptracker.map.addEventListener("mapviewchange",
    this.resetTransitionEventListener)};f.prototype.onDetach=function(){this.maptracker&&this.maptracker.map&&this.maptracker.map.removeEventListener("mapviewchange",this.resetTransitionEventListener)};f.prototype.resetTransition=function(){this.markerDomRef&&(this.setTransition(""),setTimeout(this.addMovementTransition.bind(this)))};f.prototype.addMovementTransition=function(){this.markerDomRef&&this.setTransition("transform "+(h.transition.intervalInMilliseconds||500)+"ms ease 0s")};f.prototype.setTransition=
    function(a){this.markerDomRef&&(this.markerDomRef.style.transition=a,this.bubble&&this.bubble.instant&&(this.bubble.instant.getElement().style.transition=a))};return f});m.declare("rex-maptracker-icons",{agent:"https://do6e2c3moa96p.cloudfront.net/StaticContent/pm_driver_pin.png",destination:"https://do6e2c3moa96p.cloudfront.net/StaticContent/pm_destination_pin.png",default:"https://do6e2c3moa96p.cloudfront.net/StaticContent/pm_destination_pin.png"});m.when("rex-maptracker-constants","rex-maptracker-environments",
    "pt2-page-utils","native-xhr-open-fix").register("rex-maptracker",function(g,e,l,h){function d(a){this.options=a||{};this.mapItems={};this.env=e.getEnvConfig();this.state=d.states.STARTUP;this.initialZoomTriggered=this.interactedWith=this.destroyed=!1}function f(a){r.ue&&r.ue.count&&r.ue.count(a,(r.ue.count(a)||0)+1)}var a=[];d.states={STARTUP:"STARTUP",RENDERED:"RENDERED",OUT_FOR_DELIVERY:"OUT_FOR_DELIVERY",PICKED_UP:"PICKED_UP",YOU_ARE_NEXT:"YOU_ARE_NEXT",DELIVERED:"DELIVERED",ERROR:"ERROR",FATAL:"FATAL",
    ADDRESS_NOT_FOUND:"ADDRESS_NOT_FOUND",SKIPPED_STOP:"SKIPPED_STOP",DELIVERY_FAILED:"DELIVERY_FAILED",DELIVERY_ATTEMPTED:"DELIVERY_ATTEMPTED",PARTIALLY_DELIVERED:"PARTIALLY_DELIVERED",REJECTED:"REJECTED",NOT_DELIVERED:"NOT_DELIVERED"};d.prototype.init=function(k){if(1!==k.nodeType)throw Error("containerElement must be a dom element");var b=!1;try{var e=new URL("https://www.amazon.com/");(new XMLHttpRequest).open("GET",e)}catch(t){b=!0,f("persistent-map-native-xhr-open-bug")}b&&h.isEnabled&&(b=document.createElement("iframe"),
    b.sandbox="allow-same-origin",document.body.appendChild(b),XMLHttpRequest.prototype.open=b.contentWindow.XMLHttpRequest.prototype.open);this.mapElement=k;this.platform=new H.service.Platform(g.platform.here);b=this.platform.getRasterTileService();b=new H.service.rasterTile.Provider(b);b=new H.map.layer.TileLayer(b);this.map=new H.Map(this.mapElement,b,{engineType:H.map.render.RenderEngine.EngineType.P2D,pixelRatio:1});this.map.getBaseLayer().setMin(g.minZoom).setMax(g.maxZoom);e=this.wasInteractedWith.bind(this);
    this.map.addEventListener("dragend",e);this.map.addEventListener("dbltap",e);this.map.addEventListener("tap",e);this.ui=H.ui.UI.createDefault(this.map,b);this.ui.removeControl("mapsettings");this.ui.removeControl("scalebar");this.ui.removeControl("zoom");this.ui.addControl("zoom",new H.ui.ZoomControl({fractionalZoom:!1,alignment:H.ui.LayoutAlignment.RIGHT_MIDDLE}));this.ui.getControl("zoom").getElement().style.right="-2em";(new H.mapevents.Behavior(new H.mapevents.MapEvents(this.map))).disable(H.mapevents.Behavior.Feature.FRACTIONAL_ZOOM);
    this.env.imperial&&this.ui.setUnitSystem(H.ui.UnitSystem.IMPERIAL);this.updateState(d.states.RENDERED);f("persistent-map-tracking-map-rendered");this.setHereMapsImprintPositioning();b=this.handleResize.bind(this);ResizeObserver&&(new ResizeObserver(l.debounce(b,100))).observe(k);a.push(this)};d.prototype.addItem=function(a,b){b.init(this);this.mapItems[a]=b};d.prototype.destroy=function(){this.mapElement.innerHTML="";this.destroyed=!0;var d=a.indexOf(this);-1<d&&a.splice(d,1)};d.prototype.getPadding=
    function(){var a;try{a=this.map.getViewPort().padding}catch(b){}return a};d.prototype.setPadding=function(a,b,d,e){try{this.map.getViewPort().setPadding(a,b,d,e)}catch(f){}};d.prototype.setHereMapsImprintPositioning=function(){try{var a=document.querySelector(".H_imprint"),b=document.querySelector(".H_logo"),d=document.querySelector(".H_copyright");a.classList.add("pt-map-imprint");b.classList.add("pt-map-imprint-logo");d.classList.add("pt-map-imprint-text");var e=d.childNodes[0];d.insertBefore(d.childNodes[1],
    e);var f=document.createElement("span");f.innerText="|";d.insertBefore(f,e)}catch(h){}};d.prototype.setMapBounds=function(){var a=new H.map.Group;this.map.addObject(a);var b=this.mapItems,d=null,e=0,f=null,h=0;Object.keys(b).forEach(function(g){var l=document.querySelector("."+g);g=b[g].marker;try{var p=g.getGeometry().lat;if(!d||0<p-d)e=l.getBoundingClientRect().height,d=p;if(!f||0>p-f)h=l.getBoundingClientRect().height,f=p;a.addObject(g)}catch(c){}});if(1<Object.keys(b).length&&!this.initialZoomTriggered){var g=
    this.getPadding();g&&this.setPadding(g.top+e+55,g.right,g.bottom+h+20,g.left)}this.updateMarkerBounds(a.getBoundingBox());this.initialZoomTriggered=!0};d.prototype.updateMarkerBounds=function(a){try{this.map.getViewModel().setLookAtData({bounds:a})}catch(b){}};d.prototype.updateState=function(a){this.state=a};d.prototype.wasInteractedWith=function(){this.interactedWith=!0;f("persistent-map-interaction-"+this.options.mapType)};d.prototype.handleResize=function(){this.destroyed||this.state===d.states.STARTUP||
    this.map.getViewPort().resize()};r.addEventListener("resize",l.debounce(function(){a.forEach(function(a){a.handleResize()})},100));return d});m.when("A","rex-maptracker","rex-maptracker-item","rex-maptracker-environments","ready").register("rex-maptracker-deanssource",function(g,e,l,h){function d(c,a,b,d){n.mapItems.agent?n.mapItems.agent.updateLocation(b,d):n.addItem("agent",new l("agent",b,d));n.mapItems.destination&&n.mapItems.destination.updateLocation(c,a)}function f(){if(n.mapItems.agent&&n.mapItems.agent.marker){var c=
    n.mapItems.agent.marker.getParentGroup();c&&(c.removeObject(n.mapItems.agent.marker),n.ui.removeBubble(n.mapItems.agent.bubble.instant))}}function a(c,a,b,d){"function"===typeof v.onChange&&(c={status:c,stops:a,refreshRate:30,url:k(),mapObject:n},u&&(c.destinationTrustLevel=u),p&&(c.transporterTrustLevel=p),b&&(c.message="Map tracking failed for the trackingId: "+t+" with reason: "+b),d&&(c.lastStopsRemainingDecreaseTime=d),v.onChange(c))}function k(){var c;c="localhost"===h.getTopLevelDomain()?"http://localhost:3000/mapdata":
    r.location.origin;return c+"/progress-tracker/package/actions/map-tracking-deans-proxy"}var b="",m="",t,B="",v,x=null,u=0,w=null,p=0,c=0,C=0,n,q=function(b){function n(c){C++;3>=C?(a(e.states.ERROR,0,c),h(firstTimeInvoke?50:1E4)):a(e.states.FATAL,0,c)}function h(c){setTimeout(function(){q(t,B)},c)}g.post(k(),{params:{trackingId:b,csrfToken:r.csrfToken},success:function(b){try{null!=b&&!1!==b.success||n("EMPTY_RESPONSE");var q=b.packageLocationDetails;b=null;q.destinationAddress&&q.destinationAddress.geoLocation?
    (x=b=q.destinationAddress,u=0):(b=x,u--);var k=null;q.transporterDetails&&q.transporterDetails.geoLocation?(w=k=q.transporterDetails,p=0):(k=w,p--);if(b&&-10<u&&k&&-6<p){var g=b.geoLocation.latitude,t=b.geoLocation.longitude,l=k.geoLocation.latitude,D=k.geoLocation.longitude,m=q.trackingObjectState,B=q.lastStopsRemainingDecreaseTime;C=0;switch(m){case e.states.PICKED_UP:case e.states.YOU_ARE_NEXT:d(g,t,l,D);a(m,q.stopsRemaining,"",B);h(3E4);firstTimeInvoke=!1;break;case e.states.DELIVERED:d(g,t,g,
    t);f();a(m,0,"");break;case e.states.SKIPPED_STOP:d(g,t,l,D);a(m,q.stopsRemaining,"",B);h(3E4);firstTimeInvoke=!1;break;case e.states.PARTIALLY_DELIVERED:case e.states.DELIVERY_ATTEMPTED:case e.states.NOT_DELIVERED:case e.states.REJECTED:d(g,t,l,D);f();a(m,0,"");break;default:n("UNKNOWN_STATUS")}}else firstTimeInvoke&&3>c&&-10<u&&-6<p?(c++,h(50)):a(e.states.ADDRESS_NOT_FOUND,0,"")}catch(v){n(v.stack)}},error:function(c){console.log("Error response code is - "+c.responseCode);n(c.responseCode)}})};
    return{startPolling:function(c,d){v=c;n=d;t=c.trackingId;B=c.appId||"";if(!t)throw a(e.states.FATAL,0,"MISSING_TRACKING_ID"),Error("missing trackingId");if(v.sessionId)b=v.sessionId;else{if(!document.cookie)throw a(e.states.FATAL,0,"MISSING_COOKIE"),Error("missing cookie");c="";m=document.cookie.replace(/ /g,"");for(d=0;d<m.split(";").length;d++){var C=m.split(";")[d].split("\x3d")[0],f=m.split(";")[d].split("\x3d")[1];"session-id"===C&&(c=f)}b=c}if(!b)throw a(e.states.FATAL,0,"MISSING_SESSION_ID"),
    Error("missing session id");firstTimeInvoke=!0;q(t,B)}}});m.declare("pin-smoothing-config",{delay:{defaultInMilliseconds:15E4,maxInMilliseconds:21E4,initialMaxInMilliseconds:24E4,successfullAddLocationsCountToUseDefaultMax:4},mapUpdate:{defaultIntervalInMilliseconds:1E3,fastIntervalInMilliseconds:800},polling:{defaultIntervalInMilliseconds:3E4,errorIntervalInMilliseconds:3E4,immediateIntervalInMilliseconds:50},outlier:{velocityThresholdInMetersPerSecond:200,accuracyThreshold:30},jitter:{rules:[{subsequentPoints:4,
    maxDisplacementInMeters:50},{subsequentPoints:1,maxDisplacementInMeters:15}]},interpolation:{maxDistanceToProcessInMeters:500,intervalTargetInMilliseconds:1E3},smoothing:{measurementCovariance:2,processCovariance:1,smoothingType:"KALMAN_FILTER"},transition:{maxDisplacementInMeters:Infinity,intervalInMilliseconds:800},lostSignal:{callThreshold:5}});m.when("pt2-csm-metrics-utils","rex-maptracker-constants","ready").register("rex-kalman-filter",function(g,e){function l(e,d){this.reset(e,d)}l.prototype.reset=
    function(e,d){this.processedAtLeastOnce=!1;this.measurementNoiseCovariance=this.initialMeasurementNoiseCovariance=e;this.processNoiseCovariance=d;this.errorCovarianceMatrix=this.measurementMatrix=this.stateTransitionMatrix=1;this.kalmanGain=this.stateEstimate=0};l.prototype.predict=function(e){e===A&&(e=1);this.measurementNoiseCovariance=this.initialMeasurementNoiseCovariance*e;this.stateEstimate*=this.stateTransitionMatrix;this.errorCovarianceMatrix=this.stateTransitionMatrix*this.stateTransitionMatrix*
    this.errorCovarianceMatrix+this.processNoiseCovariance};l.prototype.update=function(h,d){g.incrementCount(e.metrics.PIN_SMOOTHING_KALMAN_FILTER_UPDATE);this.kalmanGain=this.errorCovarianceMatrix*this.measurementMatrix/(this.measurementMatrix*this.measurementMatrix*this.errorCovarianceMatrix+this.measurementNoiseCovariance);this.stateEstimate=!this.processedAtLeastOnce||d?h:this.stateEstimate+this.kalmanGain*(h-this.measurementMatrix*this.stateEstimate);this.errorCovarianceMatrix*=1-this.kalmanGain*
    this.measurementMatrix;this.processedAtLeastOnce=!0;isNaN(this.stateEstimate)&&(this.stateEstimate=h,g.incrementCount(e.metrics.PIN_SMOOTHING_KALMAN_FILTER_UPDATE_ERROR),g.logWarn({feature:e.metrics.PIN_SMOOTHING_KALMAN_FILTER_UPDATE_ERROR_LOG,message:"Pin smoothing kalman filter error: stateEstimate is NaN with stateTransitionMatrix: "+this.stateTransitionMatrix+", kalmanGain: "+this.kalmanGain+", measurementMatrix: "+this.measurementMatrix}))};return l});m.when("here-route-matching-proxy","here-route-matching-request",
    "rex-maptracker-constants","pt2-csm-metrics-utils","ready").register("rex-route-filter",function(g,e,l,h){function d(d,e){return d.route&&d.route.length?d.route[0].waypoint.map(function(b){var a=e.find(function(a){return a.timestamp===b.timestamp});return f(b,a||{})}):a(b.EMPTY_ROUTE,e)}function f(b,a){return{latitude:b.mappedPosition.latitude,longitude:b.mappedPosition.longitude,accuracy:b.minError,timestamp:b.timestamp,isReal:!1,isSmoothed:a.isSmoothed||!1,interpolatedTo:a.interpolatedTo||!1,isJitterFiltered:a.isJitterFiltered||
    !1,isRouteFiltered:!0}}function a(b,a){(b=k(b))&&h.incrementCount(b);return a}function k(a){switch(a){case b.SUCCESS:return l.metrics.PIN_SMOOTHING_ROUTE_FILTER_SUCCESS;case b.ERROR:return l.metrics.PIN_SMOOTHING_ROUTE_FILTER_ERROR;case b.EMPTY_RESPONSE:return l.metrics.PIN_SMOOTHING_ROUTE_FILTER_EMPTY_RESPONSE;case b.EMPTY_ROUTE:return l.metrics.PIN_SMOOTHING_ROUTE_FILTER_EMPTY_ROUTE;default:return""}}var b={SUCCESS:"SUCCESS",ERROR:"ERROR",EMPTY_RESPONSE:"EMPTY_RESPONSE",EMPTY_ROUTE:"EMPTY_ROUTE"},
    m=new g({apiKey:l.platform.here.apikey});return{filterRoute:function(f){if(0===f.length)return Promise.resolve([]);h.incrementCount(l.metrics.PIN_SMOOTHING_ROUTE_FILTER_HIT);var g=e(f);return m.getMatchedRoute(g).then(function(e){if(!e.response)return a(b.EMPTY_RESPONSE,f);var g=k(b.SUCCESS);g&&h.incrementCount(g);return d(e.response,f)}).catch(function(d){h.logError({error:d,feature:l.metrics.PIN_SMOOTHING_ROUTE_FILTER_ERROR_LOG,message:"Pin smoothing route filter error for "+f.length+" locations"});
    return a(b.ERROR,f)})}}});m.declare("rex-route-matching",{isRouteMatchingEnabled:!0});m.when("A","rex-maptracker-item","rex-maptracker-constants","pin-smoothing-config","rex-kalman-filter","rex-route-filter","rex-route-matching","pt2-csm-metrics-utils","ready").register("rex-maptracker-location-manager",function(g,e,l,h,d,f,a,k){function b(c){var a=h.smoothing.measurementCovariance,e=h.smoothing.processCovariance;this.mapTracker=c.mapTracker;this.onLocationChange=c.onLocationChange;this.locations=
    [];this.lastDataReceivedAt=null;this.successfulAddLocationsCount=0;this.mapUpdateTimer=null;this.serverEpochDifference=0;this.state=b.states.READY;this.currentPlaybackSpeed=b.playbackSpeeds.DEFAULT;this.currentLocation=null;this.latitudeFilter=new d(a,e);this.longitudeFilter=new d(a,e)}function m(c,b){var a=b.reduce(function(c,b){return Math.max(c,b.timestamp)},0);return c.filter(function(c){return c.timestamp>a})}function t(c){return c.filter(function(b,a){var d=c[a-1];return d?!(u(d,b)>h.outlier.velocityThresholdInMetersPerSecond):
    (d=c[a+1],a=c[a+2],b=d?u(b,d)>h.outlier.velocityThresholdInMetersPerSecond:!1,d=d&&a?u(d,a)>h.outlier.velocityThresholdInMetersPerSecond:!1,!b||d)})}function r(c){c=JSON.parse(JSON.stringify(c));for(var b=0;b<c.length;b++){var a=c[b];if(!(a.accuracy<h.outlier.accuracyThreshold))if(0<b){var d=c[b-1];a.latitude=d.latitude;a.longitude=d.longitude;a.accuracy=d.accuracy}else c.splice(b,1),b--}return c}function v(b){var a=JSON.parse(JSON.stringify(b));a.forEach(function(b,c){h.jitter.rules.forEach(function(d){if(!(c+
    d.subsequentPoints>a.length)){var e=a.slice(c+1,c+1+d.subsequentPoints);e.every(function(c){return w(b,c)<=d.maxDisplacementInMeters})&&e.forEach(function(c){c.isJitterFiltered||(c.latitude=b.latitude,c.longitude=b.longitude,c.isJitterFiltered=!0,c.isReal=!1)})}})});return a}function x(c){var b=[];c.forEach(function(c,a,d){if(a=d[a-1]){var e;d=c.interpolatedTo;e=a.isReal&&c.isReal&&!d&&w(a,c)<h.interpolation.maxDistanceToProcessInMeters;d=Math.floor((c.timestamp-a.timestamp)/h.interpolation.intervalTargetInMilliseconds);
    if(e&&0<d){e=(c.latitude-a.latitude)/(d+1);for(var f=(c.longitude-a.longitude)/(d+1),g=(c.accuracy-a.accuracy)/(d+1),k=(c.timestamp-a.timestamp)/(d+1),l=0;l<d;l++)b.push(p(a.latitude+e*(l+1),a.longitude+f*(l+1),a.accuracy+g*(l+1),a.timestamp+k*(l+1),!1,!1,!0,!1,!1))}c=p(c.latitude,c.longitude,c.accuracy,c.timestamp,c.isReal,c.isSmoothed,!0,!1,!1);b.push(c)}});return b}function u(c,a){var b=(a.timestamp-c.timestamp)/1E3;return w(c,a)/b}function w(c,a){var b=Math.PI/180*(a.latitude-c.latitude),d=Math.PI/
    180*(a.longitude-c.longitude);c=Math.sin(b/2)*Math.sin(b/2)+Math.cos(Math.PI/180*c.latitude)*Math.cos(Math.PI/180*a.latitude)*Math.sin(d/2)*Math.sin(d/2);return Math.abs(12742E3*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function p(c,a,b,d,e,f,g,h,k){return{latitude:c,longitude:a,accuracy:b,timestamp:d,isReal:e,isSmoothed:f,interpolatedTo:g,isJitterFiltered:h,isRouteFiltered:k}}b.states={READY:"READY",EXECUTING:"EXECUTING",STOPPED:"STOPPED"};b.playbackSpeeds={DEFAULT:"DEFAULT",FAST:"FAST"};b.prototype.isReady=
    function(){return this.state===b.states.READY};b.prototype.addLocations=function(c){c=c.map(this.getLocationRecordFromServerModel.bind(this));c=this.getWithoutStaleLocations(c);c.sort(function(c,a){return c.timestamp-a.timestamp});c=m(c,this.locations);if(0===c.length)return Promise.resolve(!1);c=t(c);c=r(c);c=v(c);return a.isRouteMatchingEnabled?f.filterRoute(c).then(function(c){return this.handleProcessedLocations(c)}.bind(this)):Promise.resolve(this.handleProcessedLocations(c))};b.prototype.handleProcessedLocations=
    function(c){if(!c.length)return!1;c=x(c);"KALMAN_FILTER"===h.smoothing.smoothingType&&(c=this.getSmoothLocations(c));this.locations=this.getWithoutStaleLocations(this.locations.concat(c));this.successfulAddLocationsCount++;return!0};b.prototype.start=function(c){this.isReady()&&(this.state=b.states.EXECUTING,this.serverEpochDifference=c-Date.now(),this.mapUpdateTimer=setInterval(this.updateMap.bind(this),h.mapUpdate.defaultIntervalInMilliseconds))};b.prototype.stop=function(){clearInterval(this.mapUpdateTimer);
    this.state=b.states.STOPPED};b.prototype.updateMap=function(){try{var c=this.getNextLocation();if(c){if(this.isLocationValid(c)){var a=!!this.currentLocation&&w(this.currentLocation,c)<=h.transition.maxDisplacementInMeters;this.updatePinLocation(c,a)}else if(this.isLocationTooOld(c)){var d=this.locations.find(function(c){return this.isLocationValid(c)}.bind(this));d&&(a=!!this.currentLocation&&w(this.currentLocation,d)<=h.transition.maxDisplacementInMeters,this.updatePinLocation(d,a))}this.shouldFastForward()?
    this.updatePlaybackSpeed(b.playbackSpeeds.FAST):this.updatePlaybackSpeed(b.playbackSpeeds.DEFAULT)}}catch(e){k.incrementCount(l.metrics.PIN_SMOOTHING_MAP_UPDATE_ERROR),k.logError({error:e,feature:l.metrics.PIN_SMOOTHING_MAP_UPDATE_ERROR_LOG,message:"Pin smoothing map update error"})}};b.prototype.updatePinLocation=function(c,a){if(!this.currentLocation||this.currentLocation.timestamp!==c.timestamp)if(this.mapTracker.mapItems.agent?this.mapTracker.mapItems.agent.updateLocation(c.latitude,c.longitude,
    a):this.mapTracker.addItem("agent",new e("agent",c.latitude,c.longitude)),this.currentLocation=c,"function"===typeof this.onLocationChange)this.onLocationChange()};b.prototype.updatePlaybackSpeed=function(c){if(c!==this.currentPlaybackSpeed){var a;switch(c){case b.playbackSpeeds.DEFAULT:a=h.mapUpdate.defaultIntervalInMilliseconds;break;case b.playbackSpeeds.FAST:a=h.mapUpdate.fastIntervalInMilliseconds}a&&(this.mapUpdateTimer&&clearInterval(this.mapUpdateTimer),this.mapUpdateTimer=setInterval(this.updateMap.bind(this),
    a),this.playbackSpeed=c)}};b.prototype.getLocationRecordFromServerModel=function(a){return p(a.latitude,a.longitude,a.accuracy,a.epochTimestamp-this.serverEpochDifference,!0,!1,!1,!1,!1)};b.prototype.getCurrentDelay=function(){return this.currentLocation?Date.now()-this.currentLocation.timestamp:null};b.prototype.getNextLocation=function(){var a=this.currentLocation;if(!a)return this.locations[0];var b=this.locations.findIndex(function(b){return b.timestamp===a.timestamp});return this.locations[b+
    1]};b.prototype.shouldFastForward=function(){return this.getCurrentDelay()>h.delay.defaultInMilliseconds};b.prototype.getSmoothLocations=function(a){if(!this.latitudeFilter||!this.longitudeFilter)return a;a=a.map(function(a){this.latitudeFilter.predict();this.longitudeFilter.predict();this.latitudeFilter.update(a.latitude,a.isSmoothed);this.longitudeFilter.update(a.longitude,a.isSmoothed);return p(this.latitudeFilter.stateEstimate,this.longitudeFilter.stateEstimate,a.accuracy,a.timestamp,a.isReal,
    !0,a.interpolatedTo,a.isJitterFiltered,a.isRouteFiltered)}.bind(this));this.latitudeFilter.reset();this.longitudeFilter.reset();return a};b.prototype.getWithoutStaleLocations=function(a){return a.filter(function(a){return!this.isLocationTooOld(a)}.bind(this))};b.prototype.isLocationValid=function(a){return!this.isLocationTooOld(a)&&!this.isLocationTooRecent(a)};b.prototype.isLocationTooOld=function(a){return a.timestamp<this.getMinEpochRenderThreshold()};b.prototype.isLocationTooRecent=function(a){return a.timestamp>
    Date.now()};b.prototype.getMinEpochRenderThreshold=function(){var a=this.successfulAddLocationsCount<h.delay.successfullAddLocationsCountToUseDefaultMax?h.delay.initialMaxInMilliseconds:h.delay.maxInMilliseconds;return Date.now()-a};return b});m.when("A","rex-maptracker","rex-maptracker-location-manager","rex-maptracker-constants","pin-smoothing-config","pt2-csm-metrics-utils","ready").register("rex-maptracker-data-source",function(g,e,l,h,d,f){function a(a,b,c,d){"function"===typeof n.onDataReceived&&
    (a={status:a,stops:b,url:B(),mapObject:y},c&&(a.message="Map tracking failed for the trackingId: "+u+" with reason: "+c),d&&(a.packageLocationState=d),n.onDataReceived(a))}function k(b,l,v,x,y){function F(b){f.incrementCount(h.metrics.PIN_SMOOTHING_AJAX_ERROR);m();A<=d.lostSignal.callThreshold&&(a(e.states.ERROR,0,b),G(E?d.polling.immediateIntervalInMilliseconds:d.polling.errorIntervalInMilliseconds))}function G(a){J||setTimeout(function(){k(u,w,p,c,C)},a)}function I(b){var c=b.mapState||{},f=c.status,
    g=E?d.polling.immediateIntervalInMilliseconds:d.polling.defaultIntervalInMilliseconds;switch(f){case e.states.PICKED_UP:case e.states.YOU_ARE_NEXT:a(f,c.stops,z.EMPTY_REASON,b);G(g);break;case e.states.DELIVERED:q.stop();t();a(f,0,z.EMPTY_REASON,b);break;case e.states.SKIPPED_STOP:updateMapItems(destLat,destLong,daLat,daLong);a(f,c.stops,z.EMPTY_REASON,b);G(g);break;case e.states.PARTIALLY_DELIVERED:case e.states.DELIVERY_ATTEMPTED:case e.states.NOT_DELIVERED:case e.states.REJECTED:t();a(f,0,z.EMPTY_REASON);
    break;default:F(z.UNKNOWN_STATUS)}}var K=B();g.post(K,{params:{trackingId:b,visitTrigger:l,timezone:v,csrfToken:r.csrfToken,numberOfMemoizations:D,driverNameTitle:x,isDriverPhotoPresent:y},withCredentials:!0,success:function(a){try{if(a&&a.success&&a.value){D++;var b=a.value,c=b.packageLocationTimeline;c&&q.addLocations(c).then(function(a){a?(A=0,E=!1):m();q.isReady()&&q.start(b.currentEpoch);I(b)})}else{F(z.EMPTY_RESPONSE);if("function"===typeof n.onDataReceivedError)n.onDataReceivedError(z.EMPTY_RESPONSE);
    I(b)}}catch(d){F(d.stack),I(b)}},error:function(a,b,c){console.log("Error is :: "+a.responseText+" "+b+" "+c);F(a.responseText)}})}function b(){if("function"===typeof n.onLocationChange)n.onLocationChange()}function m(){A++;A>d.lostSignal.callThreshold&&"function"===typeof n.onDriverLostSignal&&(q.stop(),J=!0,n.onDriverLostSignal())}function t(){if(y.mapItems.agent&&y.mapItems.agent.marker){var a=y.mapItems.agent.marker.getParentGroup();a&&(a.removeObject(y.mapItems.agent.marker),y.ui.removeBubble(y.mapItems.agent.bubble.instant))}}
    function B(){return r.location.origin+"/progress-tracker/package/actions/package-location/get-state"}var v="",x="",u,w,p,c,C,n,q={},D=0,z={EMPTY_REASON:"",MISSING_TRACKING_ID:"MISSING_TRACKING_ID",MISSING_SESSION_ID:"MISSING_SESSION_ID",MISSING_COOKIE:"MISSING_COOKIE",EMPTY_RESPONSE:"EMPTY_RESPONSE",UNKNOWN_STATUS:"UNKNOWN_STATUS"},A=0,E,J=!1,y;return{startPolling:function(d,f){n=d;y=f;u=d.trackingId;w=d.visitTrigger;p=d.timezone;c=d.driverNameTitle;C=d.isDriverPhotoPresent;q=new l({mapTracker:y,
    onLocationChange:b});if(!u)throw a(e.states.FATAL,0,z.MISSING_TRACKING_ID),Error("Missing trackingId");if(n.sessionId)v=n.sessionId;else{if(!document.cookie)throw a(e.states.FATAL,0,z.MISSING_COOKIE),Error("missing cookie");d="";x=document.cookie.replace(/ /g,"");for(f=0;f<x.split(";").length;f++){var g=x.split(";")[f].split("\x3d")[0],h=x.split(";")[f].split("\x3d")[1];"session-id"===g&&(d=h)}v=d}if(!v)throw a(e.states.FATAL,0,z.MISSING_SESSION_ID),Error("missing session id");E=!0;k(u,w,p,c,C)}}});
    m.when("A","pt2-csm-metrics-utils","rex-maptracker-constants").register("here-route-matching-proxy",function(g,e,l){function h(d){this.apiKey=d.apiKey;this.baseUrl="https://routematching.hereapi.com/v8/match/routelinks";this.scopePrefix="mapTrackerHereRouteMatchingAjaxLatencyScope";this.scopeIdentifier=1}h.prototype.getMatchedRoute=function(d){var f=this._buildUrl(),a=this._buildCsmScope();this._incrementScopeIdentifier();e.setPreAjax(a);var h=performance.now();return new Promise(function(b,l){g.post(f,
    {params:JSON.stringify(d),contentType:"application/json; charset\x3dutf-8",paramsFormat:"json",success:this._handleResponse(b,l,e,a,h).bind(this),error:function(b){this._handlePostAjax(a,h);l(b)}.bind(this)})}.bind(this))};h.prototype._buildUrl=function(){var d=new URL(this.baseUrl);d.searchParams.set("routeMatch","1");d.searchParams.set("mode","car");this.apiKey&&d.searchParams.set("apiKey",this.apiKey);return d.toString()};h.prototype._handleResponse=function(d,e,a,g,b){return function(a){this._handlePostAjax(g,
    b);a.error_id?e(a):d(a)}.bind(this)};h.prototype._buildCsmScope=function(){return e.setScope(this.scopePrefix+this.scopeIdentifier)};h.prototype._incrementScopeIdentifier=function(){this.scopeIdentifier++};h.prototype._handlePostAjax=function(d,f){this._recordPostAjaxLatencyMetric(f);e.setPostAjax(d);e.sendAjaxMetrics(d)};h.prototype._recordPostAjaxLatencyMetric=function(d){var f=performance.now();e.recordInterval(l.metrics.HERE_ROUTE_MATCHING_LATENCY,f-d)};return h});m.register("here-route-matching-request",
    function(){function g(e){return{type:"Feature",properties:{provider:"gps",timestamp_msec:e.timestamp,accuracy:e.accuracy},geometry:{type:"Point",coordinates:[e.longitude,e.latitude]}}}return function(e){return{type:"FeatureCollection",features:e.map(g)}}});m.declare("native-xhr-open-fix",{isEnabled:!1})});